---
title: "Workflow"
layout: docs-index
weight: 40
docsMenuTitle: "Workflow"
description: "A full tutorial covering simple Agrest application"
---
<div class="sect1">
<h2 id="create-a-simple-agrest-app"><a class="anchor" href="#create-a-simple-agrest-app"></a>1. Create a Simple <code>Agrest</code> App</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter, we set up a minimal environment to build an Agrest-based application.</p>
</div>
<div class="sect3">
<h4 id="install-java"><a class="anchor" href="#install-java"></a>1.1. Install Java</h4>
<div class="paragraph">
<p>Install Java 1.8 or later.</p>
</div>
</div>
<div class="sect3">
<h4 id="install-intellij-idea"><a class="anchor" href="#install-intellij-idea"></a>1.2. Install IntelliJ IDEA</h4>
<div class="paragraph">
<p>Download and install IntelliJ IDEA or your own preferred Java IDE.</p>
</div>
</div>
<div class="sect3">
<h4 id="the-resulting-application"><a class="anchor" href="#the-resulting-application"></a>1.3. The resulting application</h4>
<div class="paragraph">
<p>The final application is available at
<a href="https://github.com/agrestio/agrest-examples/tree/main/agrest4-jaxrs-cayenne">from GitHub</a></p>
</div>
</div>
<div class="sect2">
<h3 id="starting-a-project"><a class="anchor" href="#starting-a-project"></a>1.4. Starting a project</h3>
<div class="paragraph">
<p>In this chapter, we create a new Java project in IntelliJ IDEA
and introduce a simple Bookstore application that will be used as an example.</p>
</div>
<div class="sect3">
<h4 id="define-a-bookstore-domain-model"><a class="anchor" href="#define-a-bookstore-domain-model"></a>1.4.1. Define a <code>Bookstore</code> Domain Model</h4>
<div class="paragraph">
<p>The application contains two types of entities: <code>Category</code> and <code>Book</code>.
The relationship between <code>Category</code> and <code>Book</code> entities is <strong>one-to-many</strong>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/images/workflow/bookstore_er_diagram.png" alt="bookstore er diagram">
</div>
</div>
</div>
<div class="sect3">
<h4 id="create-a-new-project-in-intellij-idea"><a class="anchor" href="#create-a-new-project-in-intellij-idea"></a>1.4.2. Create a new Project in IntelliJ IDEA</h4>
<div class="paragraph">
<p>In IntelliJ IDEA, select <code>File &gt; New &gt; Project..</code>. Then select <code>Maven</code> and click <code>Next</code>.</p>
</div>
<div class="paragraph">
<p>In the dialog shown on the screenshot below, fill in the <code>Group Id</code>
and <code>Artifact Id</code> fields and click <code>Next</code>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/images/workflow/tutorial-idea-project.png" alt="tutorial idea project">
</div>
</div>
<div class="paragraph">
<p>During the next step, you will be able to customize the directory for your project.
Click <code>Finish</code> where you are done. Now you should have a new empty project.</p>
</div>
</div>
<div class="sect3">
<h4 id="configure-maven-pom-xml"><a class="anchor" href="#configure-maven-pom-xml"></a>1.4.3. Configure Maven <code>pom.xml</code></h4>
<div class="paragraph">
<p>Add the following dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.agrest&lt;/groupId&gt;
    &lt;artifactId&gt;agrest&lt;/artifactId&gt;
    &lt;version&gt;4.9&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.glassfish.jersey.containers&lt;/groupId&gt;
    &lt;artifactId&gt;jersey-container-servlet-core&lt;/artifactId&gt;
    &lt;version&gt;2.35&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.glassfish.jersey.inject&lt;/groupId&gt;
    &lt;artifactId&gt;jersey-hk2&lt;/artifactId&gt;
    &lt;version&gt;2.35&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.apache.derby&lt;/groupId&gt;
    &lt;artifactId&gt;derby&lt;/artifactId&gt;
    &lt;version&gt;10.15.2.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure a <code>jetty</code> Maven plugin to start app using <code>mvn jetty:run</code> command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;plugin&gt;
    &lt;groupId&gt;org.eclipse.jetty&lt;/groupId&gt;
    &lt;artifactId&gt;jetty-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;10.0.7&lt;/version&gt;
    &lt;configuration&gt;
        &lt;scanIntervalSeconds&gt;5&lt;/scanIntervalSeconds&gt;
        &lt;classesDirectory&gt;${project.basedir}/target/classes&lt;/classesDirectory&gt;
        &lt;supportedPackagings&gt;&lt;supportedPackaging&gt;jar&lt;/supportedPackaging&gt;&lt;/supportedPackagings&gt;
    &lt;/configuration&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="implementation"><a class="anchor" href="#implementation"></a>1.5. Implementation</h3>
<div class="paragraph">
<p>In this chapter, we implement a simple application to demonstrate Agrest features.
The application uses <code>Cayenne</code> as an ORM framework and for further information
regarding a DB mapping please, refer to <a href="http://cayenne.apache.org">Apache Cayenne ORM</a></p>
</div>
<div class="sect3">
<h4 id="configure-cayenne"><a class="anchor" href="#configure-cayenne"></a>1.5.1. Configure <code>Cayenne</code></h4>
<div class="paragraph">
<p>In the application&#8217;s <code>resources</code> folder, create a Cayenne project file:</p>
</div>
<div class="paragraph">
<p><strong>cayenne-project.xml</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;domain project-version="9"&gt;
    &lt;map name="datamap"/&gt;

    &lt;node name="datanode"
          factory="org.apache.cayenne.configuration.server.XMLPoolingDataSourceFactory"
          schema-update-strategy="org.apache.cayenne.access.dbsync.CreateIfNoSchemaStrategy"
    &gt;
        &lt;map-ref name="datamap"/&gt;
        &lt;data-source&gt;
            &lt;driver value="org.apache.derby.iapi.jdbc.AutoloadedDriver"/&gt;
            &lt;url value="jdbc:derby:memory:testdb;create=true"/&gt;
            &lt;connectionPool min="1" max="1"/&gt;
            &lt;login/&gt;
        &lt;/data-source&gt;
    &lt;/node&gt;
&lt;/domain&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the same folder, add a file that contains a basic Cayenne mapping.
The mapping is done based on the ER diagram from the <a href="#starting-a-project">Starting a project</a> charter:</p>
</div>
<div class="paragraph">
<p><strong>datamap.map.xml</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;data-map xmlns="http://cayenne.apache.org/schema/9/modelMap"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://cayenne.apache.org/schema/9/modelMap https://cayenne.apache.org/schema/9/modelMap.xsd"
          project-version="9"&gt;
    &lt;property name="defaultPackage" value="org.example.agrest.persistent"/&gt;
    &lt;db-entity name="BOOK"&gt;
        &lt;db-attribute name="AUTHOR" type="VARCHAR" length="128"/&gt;
        &lt;db-attribute name="CATEGORY_ID" type="INTEGER"/&gt;
        &lt;db-attribute name="ID" type="INTEGER" isPrimaryKey="true" isMandatory="true"/&gt;
        &lt;db-attribute name="TITLE" type="VARCHAR" isMandatory="true" length="128"/&gt;
    &lt;/db-entity&gt;
    &lt;db-entity name="CATEGORY"&gt;
        &lt;db-attribute name="DESCRIPTION" type="NCLOB"/&gt;
        &lt;db-attribute name="ID" type="INTEGER" isPrimaryKey="true" isMandatory="true"/&gt;
        &lt;db-attribute name="NAME" type="VARCHAR" isMandatory="true" length="128"/&gt;
    &lt;/db-entity&gt;
    &lt;obj-entity name="Book" className="org.example.agrest.persistent.Book" dbEntityName="BOOK"&gt;
        &lt;obj-attribute name="author" type="java.lang.String" db-attribute-path="AUTHOR"/&gt;
        &lt;obj-attribute name="title" type="java.lang.String" db-attribute-path="TITLE"/&gt;
    &lt;/obj-entity&gt;
    &lt;obj-entity name="Category" className="org.example.agrest.persistent.Category" dbEntityName="CATEGORY"&gt;
        &lt;obj-attribute name="description" type="java.lang.String" db-attribute-path="DESCRIPTION"/&gt;
        &lt;obj-attribute name="name" type="java.lang.String" db-attribute-path="NAME"/&gt;
    &lt;/obj-entity&gt;
    &lt;db-relationship name="category" source="BOOK" target="CATEGORY" toMany="false"&gt;
        &lt;db-attribute-pair source="CATEGORY_ID" target="ID"/&gt;
    &lt;/db-relationship&gt;
    &lt;db-relationship name="books" source="CATEGORY" target="BOOK" toMany="true"&gt;
        &lt;db-attribute-pair source="ID" target="CATEGORY_ID"/&gt;
    &lt;/db-relationship&gt;
    &lt;obj-relationship name="category" source="Book" target="Category" deleteRule="Nullify" db-relationship-path="category"/&gt;
    &lt;obj-relationship name="books" source="Category" target="Book" deleteRule="Deny" db-relationship-path="books"/&gt;
&lt;/data-map&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="define-domain-models"><a class="anchor" href="#define-domain-models"></a>1.5.2. Define domain models</h4>
<div class="paragraph">
<p>Create two classes to present data objects in package <code>org.example.agrest.persistent</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-Java" data-lang="Java">public class Category extends CayenneDataObject {

    public static final String ID_PK_COLUMN = "ID";

    public static final Property&lt;String&gt; DESCRIPTION = Property.create("description", String.class);
    public static final Property&lt;String&gt; NAME = Property.create("name", String.class);
    public static final Property&lt;List&lt;Book&gt;&gt; BOOKS = Property.create("books", List.class);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-Java" data-lang="Java">public class Book extends CayenneDataObject {

    public static final String ID_PK_COLUMN = "ID";

    public static final Property&lt;String&gt; AUTHOR = Property.create("author", String.class);
    public static final Property&lt;String&gt; TITLE = Property.create("title", String.class);
    public static final Property&lt;Category&gt; CATEGORY = Property.create("category", Category.class);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="implement-agrest-application-classes"><a class="anchor" href="#implement-agrest-application-classes"></a>1.5.3. Implement <code>Agrest</code> application classes</h4>
<div class="paragraph">
<p>Create an application and a resource class in package <code>org.example.agrest</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-Java" data-lang="Java">@ApplicationPath("/api/*")
public class Application extends ResourceConfig {

    public Application() {

        ServerRuntime cayenneRuntime = ServerRuntime.builder()
            .addConfig("cayenne-project.xml")
            .build();

        AgRuntime agRuntime = AgBuilder.build(cayenneRuntime);
        super.register(agRuntime);

        packages("org.example.agrest");
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-Java" data-lang="Java">@Path("category")
@Produces(MediaType.APPLICATION_JSON)
public class CategoryResource {

    @Context
    private Configuration config;

    @POST
    public SimpleResponse create(String data) {
        return Ag.create(Category.class, config).sync(data);
    }

    @GET
    public DataResponse&lt;Category&gt; getAll(@Context UriInfo uriInfo) {
        return Ag.select(Category.class, config).uri(uriInfo).get();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configure-web-xml"><a class="anchor" href="#configure-web-xml"></a>1.5.4. Configure <code>web.xml</code></h4>
<div class="paragraph">
<p>Provide a servlet configuration and a mapping based on the application class that you already created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-XML" data-lang="XML">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"
         metadata-complete="false"
         version="3.1"&gt;

    &lt;servlet&gt;
        &lt;servlet-name&gt;api&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.glassfish.jersey.servlet.ServletContainer&lt;/servlet-class&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;javax.ws.rs.Application&lt;/param-name&gt;
            &lt;param-value&gt;org.example.agrest.Application&lt;/param-value&gt;
        &lt;/init-param&gt;
    &lt;/servlet&gt;

    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;api&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/api/*&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;

&lt;/web-app&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="running-the-application"><a class="anchor" href="#running-the-application"></a>1.6. Running the Application</h3>
<div class="paragraph">
<p>In this chapter, we run and test our application.
After you have completed the above steps, the structure of your project will look like this:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="/images/workflow/bookstore_ide_prjct.png" alt="bookstore ide prjct">
</div>
</div>
<div class="sect3">
<h4 id="building-and-running"><a class="anchor" href="#building-and-running"></a>1.6.1. Building and running</h4>
<div class="paragraph">
<p>To build the application, use the <code>mvn clean install</code> command.</p>
</div>
<div class="paragraph">
<p>To run a jetty server with our application, use the mvn jetty:run command.</p>
</div>
</div>
<div class="sect3">
<h4 id="configure-intellij-idea-maven-plugin"><a class="anchor" href="#configure-intellij-idea-maven-plugin"></a>1.6.2. Configure IntelliJ IDEA Maven plugin</h4>
<div class="paragraph">
<p>To run the application using IDE, add a new <code>Maven</code> configuration on a menu path <code>Run &#8594; Edit Configurations&#8230;&#8203;</code>.
Then set a <code>Name:</code> (e.g. <strong>Bookstore</strong>) and a <code>Command line:</code> in <strong>jetty:run</strong></p>
</div>
</div>
<div class="sect3">
<h4 id="testing"><a class="anchor" href="#testing"></a>1.6.3. Testing</h4>
<div class="paragraph">
<p>After running the application, you can call this endpoint to get a list of categories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl -i -X GET 'http://localhost:8080/api/category'</code></pre>
</div>
</div>
<div class="paragraph">
<p>And get the following response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-JSON" data-lang="JSON">HTTP/1.1 200 OK
Date: Wed, 03 Oct 2018 10:14:51 GMT
Content-Type: application/json
Content-Length: 21
Server: Jetty(9.3.14.v20161028)

{"data":[],"total":0}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you may see, the list is empty. So, use the 'POST' command to add some categories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl -i -X POST 'http://localhost:8080/api/category'  -d '{"id":"1","name":"Science Fiction"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Repeat the command, if necessary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>curl -i -X POST 'http://localhost:8080/api/category' -d '{"id":"2","name":"Horror"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response will be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-JSON" data-lang="JSON">HTTP/1.1 201 Created
Date: Wed, 03 Oct 2018 10:42:17 GMT
Content-Type: application/json
Content-Length: 16
Server: Jetty(9.3.14.v20161028)

{"success":true}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now make the 'GET' request again and you will receive the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-JSON" data-lang="JSON">HTTP/1.1 200 OK
Date: Wed, 03 Oct 2018 10:44:44 GMT
Content-Type: application/json
Content-Length: 117
Server: Jetty(9.3.14.v20161028)

{"data":[{"id":1,"description":null,"name":"Science Fiction"},{"id":2,"description":null,"name":"Horror"}],"total":2}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>